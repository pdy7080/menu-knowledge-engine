name: CD - Deploy to Production

on:
  push:
    branches:
      - master
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    name: Deploy to Chargeap Server
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.CHARGEAP_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.CHARGEAP_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to Server (Python venv + uvicorn)
        env:
          HOST: ${{ secrets.CHARGEAP_HOST }}
          USER: ${{ secrets.CHARGEAP_USER }}
          DEPLOY_PATH: ${{ secrets.CHARGEAP_DEPLOY_PATH }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
        run: |
          ssh $USER@$HOST << 'ENDSSH'
            set -e

            echo "üöÄ Starting deployment to Chargeap Server..."

            # Navigate to deployment directory
            cd $DEPLOY_PATH

            # Pull latest code
            echo "üì• Pulling latest code..."
            git fetch origin
            git checkout master
            git pull origin master

            # Navigate to backend
            cd app/backend

            # Create/activate venv if not exists
            if [ ! -d "venv" ]; then
              echo "üì¶ Creating Python virtual environment..."
              python3 -m venv venv
            fi

            # Activate venv
            source venv/bin/activate

            # Install/update dependencies
            echo "üì¶ Installing dependencies..."
            pip install --upgrade pip
            pip install -r requirements.txt

            # Kill old uvicorn process (if any)
            echo "üõë Stopping existing uvicorn process..."
            pkill -f "uvicorn" || true
            sleep 2

            # Start uvicorn in background
            echo "üöÄ Starting uvicorn server..."
            nohup uvicorn main:app --host 127.0.0.1 --port 8000 --workers 2 > logs/uvicorn.log 2>&1 &

            # Wait for server to start
            echo "‚è≥ Waiting for server to start..."
            sleep 5

            # Health check
            echo "üè• Running health check..."
            max_attempts=5
            attempt=1
            while [ $attempt -le $max_attempts ]; do
              if curl -f http://localhost:8000/health > /dev/null 2>&1; then
                echo "‚úÖ Health check passed!"
                break
              fi
              echo "‚è≥ Health check attempt $attempt/$max_attempts..."
              sleep 2
              attempt=$((attempt + 1))
            done

            if [ $attempt -gt $max_attempts ]; then
              echo "‚ùå Health check failed after $max_attempts attempts"
              exit 1
            fi

            echo "‚úÖ Deployment successful!"

          ENDSSH

      - name: Verify Deployment
        env:
          HOST: ${{ secrets.CHARGEAP_HOST }}
          USER: ${{ secrets.CHARGEAP_USER }}
          DEPLOY_PATH: ${{ secrets.CHARGEAP_DEPLOY_PATH }}
        run: |
          ssh $USER@$HOST << 'ENDSSH'
            echo "üìä Backend Status:"
            ps aux | grep uvicorn | grep -v grep || echo "‚ö†Ô∏è No uvicorn process found"

            echo ""
            echo "üìã Recent Logs:"
            if [ -f "$DEPLOY_PATH/app/backend/logs/uvicorn.log" ]; then
              tail -20 "$DEPLOY_PATH/app/backend/logs/uvicorn.log"
            fi

          ENDSSH

      - name: Notify Success
        if: success()
        run: |
          echo "‚úÖ Deployment to production completed successfully!"
          echo "üîó API Endpoint: http://${{ secrets.CHARGEAP_HOST }}:8000"
          echo "üîó Health Check: http://${{ secrets.CHARGEAP_HOST }}:8000/health"

      - name: Notify Failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo "Please check the logs and rollback if necessary."
