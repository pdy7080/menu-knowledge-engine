<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu Queue - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .badge-pending { @apply bg-yellow-100 text-yellow-800; }
        .badge-confirmed { @apply bg-green-100 text-green-800; }
        .badge-rejected { @apply bg-red-100 text-red-800; }
        .badge-b2c { @apply bg-blue-100 text-blue-800; }
        .badge-b2b { @apply bg-purple-100 text-purple-800; }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <h1 class="text-2xl font-bold text-gray-900">Menu Knowledge Engine</h1>
                    </div>
                    <div class="ml-6 flex space-x-8">
                        <a href="index.html" class="border-transparent inline-flex items-center px-1 pt-1 text-sm font-medium text-gray-500 hover:text-gray-700">
                            Dashboard
                        </a>
                        <a href="queue.html" class="border-b-2 border-blue-500 inline-flex items-center px-1 pt-1 text-sm font-medium text-gray-900">
                            Menu Queue
                        </a>
                        <a href="stats.html" class="border-transparent inline-flex items-center px-1 pt-1 text-sm font-medium text-gray-500 hover:text-gray-700">
                            Statistics
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Filters -->
        <div class="bg-white shadow rounded-lg p-6 mb-6">
            <div class="flex flex-wrap gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="filterStatus" class="rounded-md border-gray-300 shadow-sm">
                        <option value="all">All</option>
                        <option value="pending" selected>Pending</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Source</label>
                    <select id="filterSource" class="rounded-md border-gray-300 shadow-sm">
                        <option value="all" selected>All</option>
                        <option value="b2c">B2C Scan</option>
                        <option value="b2b">B2B Upload</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button onclick="loadQueue()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        Apply Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Queue Table -->
        <div class="bg-white shadow rounded-lg overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-900">New Menu Queue</h2>
                <p class="mt-1 text-sm text-gray-600" id="queueCount">Loading...</p>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Menu Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Confidence</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Matched Menu</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created At</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="queueTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Rows will be inserted here -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-700" id="paginationInfo">
                        Loading...
                    </div>
                    <div class="flex gap-2">
                        <button onclick="previousPage()" id="btnPrev" class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50" disabled>
                            Previous
                        </button>
                        <button onclick="nextPage()" id="btnNext" class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50">
                            Next
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Approve/Reject Modal -->
    <div id="actionModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="modalTitle">Approve Menu</h3>
                <div class="mt-4">
                    <p class="text-sm text-gray-500" id="modalMenuName"></p>
                    <textarea id="modalNotes" placeholder="Notes (optional)" class="mt-3 w-full px-3 py-2 border border-gray-300 rounded-md" rows="3"></textarea>
                </div>
                <div class="mt-4 flex gap-2 justify-end">
                    <button onclick="closeModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">
                        Cancel
                    </button>
                    <button onclick="confirmAction()" id="btnConfirm" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 0;
        const pageSize = 50;
        let currentAction = null;
        let currentQueueId = null;

        // API base URL (동적 설정)
        const API_BASE = window.location.origin || 'http://localhost:8000';

        // XSS 방지 함수
        function escapeHtml(unsafe) {
            if (!unsafe || typeof unsafe !== 'string') {
                return '';
            }
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Load queue on page load
        window.onload = function() {
            loadQueue();
        };

        async function loadQueue() {
            const status = document.getElementById('filterStatus').value;
            const source = document.getElementById('filterSource').value;

            try {
                const response = await fetch(
                    `${API_BASE}/api/v1/admin/queue?status=${status}&source=${source}&limit=${pageSize}&offset=${currentPage * pageSize}`
                );

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                renderQueue(data);
            } catch (error) {
                console.error('Error loading queue:', error);
                document.getElementById('queueTableBody').innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-red-600">
                            Error loading queue: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        function renderQueue(data) {
            const tbody = document.getElementById('queueTableBody');
            const countEl = document.getElementById('queueCount');
            const paginationEl = document.getElementById('paginationInfo');

            // Update count
            countEl.textContent = `Total: ${data.total} items`;

            // Update pagination
            const start = currentPage * pageSize + 1;
            const end = Math.min(start + pageSize - 1, data.total);
            paginationEl.textContent = `Showing ${start}-${end} of ${data.total}`;

            // Enable/disable pagination buttons
            document.getElementById('btnPrev').disabled = currentPage === 0;
            document.getElementById('btnNext').disabled = end >= data.total;

            // Render rows
            if (data.data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                            No items found
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = data.data.map(item => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${escapeHtml(item.menu_name_ko)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full badge-${item.source}">
                            ${item.source.toUpperCase()}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full badge-${item.status}">
                            ${item.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${(item.confidence * 100).toFixed(1)}%
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${item.matched_canonical ? item.matched_canonical.name_ko : '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${new Date(item.created_at).toLocaleDateString('ko-KR')}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        ${item.status === 'pending' ? `
                            <button onclick="openModal('approve', '${item.id}', '${item.menu_name_ko}')" class="text-green-600 hover:text-green-900 mr-3">
                                Approve
                            </button>
                            <button onclick="openModal('reject', '${item.id}', '${item.menu_name_ko}')" class="text-red-600 hover:text-red-900">
                                Reject
                            </button>
                        ` : '-'}
                    </td>
                </tr>
            `).join('');
        }

        function openModal(action, queueId, menuName) {
            currentAction = action;
            currentQueueId = queueId;

            const modal = document.getElementById('actionModal');
            const title = document.getElementById('modalTitle');
            const menuNameEl = document.getElementById('modalMenuName');
            const confirmBtn = document.getElementById('btnConfirm');

            title.textContent = action === 'approve' ? 'Approve Menu' : 'Reject Menu';
            menuNameEl.textContent = `Menu: ${menuName}`;
            confirmBtn.textContent = action === 'approve' ? 'Approve' : 'Reject';
            confirmBtn.className = action === 'approve'
                ? 'px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600'
                : 'px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600';

            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('actionModal').classList.add('hidden');
            document.getElementById('modalNotes').value = '';
            currentAction = null;
            currentQueueId = null;
        }

        async function confirmAction() {
            const notes = document.getElementById('modalNotes').value;

            try {
                const response = await fetch(
                    `${API_BASE}/api/v1/admin/queue/${currentQueueId}/approve`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: currentAction,
                            notes: notes || null
                        })
                    }
                );

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                alert(result.message);
                closeModal();
                loadQueue(); // Reload queue

            } catch (error) {
                console.error('Error performing action:', error);
                alert(`Error: ${error.message}`);
            }
        }

        function previousPage() {
            if (currentPage > 0) {
                currentPage--;
                loadQueue();
            }
        }

        function nextPage() {
            currentPage++;
            loadQueue();
        }
    </script>
</body>
</html>
