# 04. Data Flow Scenarios — 3가지 핵심 시퀀스

> **이 문서는 "데이터가 시스템을 어떻게 흐르는가"를 정의한다.**  
> 모든 시퀀스에서 03_data_schema의 테이블이 어떻게 사용되는지 명시한다.

---

## Scenario 1: B2B — 사장님 메뉴 업로드

### 전제
- 사장님이 성수야(또는 자체 서비스)에 가게를 등록한 상태
- 메뉴판 사진을 업로드

### 시퀀스

```
사장님                   프론트엔드              Menu Knowledge Engine          DB
  │                        │                           │                       │
  │  메뉴판 사진 업로드      │                           │                       │
  │ ──────────────────────>│                           │                       │
  │                        │  POST /menu/recognize      │                       │
  │                        │ ─────────────────────────>│                       │
  │                        │                           │                       │
  │                        │                    [1] OCR 호출 (CLOVA OCR)       │
  │                        │                    [2] 텍스트 후처리 (LLM)         │
  │                        │                    [3] 메뉴명 후보 리스트 추출      │
  │                        │                           │                       │
  │                        │                    [4] 각 메뉴명에 대해:           │
  │                        │                    ┌──────┴──────┐                │
  │                        │              DB 매칭 시도          │                │
  │                        │              (canonical_menus      │                │
  │                        │               + 수식어 분해)        │                │
  │                        │                    │               │                │
  │                        │              ┌─────┴─────┐        │                │
  │                        │           매칭 성공    매칭 실패     │                │
  │                        │              │           │          │                │
  │                        │       variant 생성  AI Discovery   │                │
  │                        │              │      (GPT-4o)       │                │
  │                        │              │           │          │                │
  │                        │              │    신규 canonical    │                │
  │                        │              │    + variant 생성    │                │
  │                        │              │    + evidence 기록   │                │
  │                        │              └─────┬─────┘         │                │
  │                        │                    │                │                │
  │                        │  결과: 메뉴 리스트    │                │                │
  │                        │ <─────────────────│                │                │
  │                        │                                                    │
  │  확인 화면 표시          │                                                    │
  │ <──────────────────────│                                                    │
  │                        │                                                    │
  │  [확인] / [수정]        │                                                    │
  │ ──────────────────────>│                                                    │
  │                        │  POST /menu/confirm                                │
  │                        │ ─────────────────────────────────────────────────>│
  │                        │                                                    │
  │                        │        [DB 저장]                                   │
  │                        │        - menu_variants (확정)                       │
  │                        │        - shops.menu_count 업데이트                  │
  │                        │        - human_verified = true (수정 시)            │
  │                        │                                                    │
  │                        │  QR 페이지 URL 반환                                 │
  │                        │ <─────────────────────────────────────────────────│
  │                        │                                                    │
  │  QR 코드 수령           │                                                    │
  │ <──────────────────────│                                                    │
```

### DB 변화

| 테이블 | 동작 |
|---|---|
| `canonical_menus` | 신규 메뉴 발견 시 INSERT |
| `menu_variants` | 각 메뉴명에 대해 INSERT (source: 'b2b_upload') |
| `modifiers` | 새 수식어 발견 시 INSERT |
| `evidences` | AI 사용 시 근거 기록 INSERT |
| `shops` | menu_count, has_multilingual 업데이트 |

### 핵심 지표

- OCR 정확도 (메뉴명 추출 성공률)
- DB 매칭률 (AI 호출 없이 처리된 비율)
- 사장님 수정률 (낮을수록 품질 높음)

---

## Scenario 2: B2C — 외국인 메뉴판 촬영

### 전제
- 외국인 관광객이 식당에서 메뉴판을 보고 있음
- 웹앱(PWA)으로 접근, 앱 설치 불필요
- 언어: 영어

### 시퀀스

```
외국인               웹앱 (PWA)            Menu Knowledge Engine          DB
  │                     │                          │                      │
  │  카메라로 촬영        │                          │                      │
  │ ──────────────────>│                          │                      │
  │                     │  POST /menu/recognize     │                      │
  │                     │ ────────────────────────>│                      │
  │                     │                          │                      │
  │                     │                   [1] OCR                       │
  │                     │                   [2] 메뉴명 추출                │
  │                     │                   [3] 각 메뉴명:                 │
  │                     │                          │                      │
  │                     │                   ┌──────┴──────────┐           │
  │                     │                   │ DB 매칭          │           │
  │                     │                   │ (name 정확매칭    │           │
  │                     │                   │  → trgm 유사매칭  │           │
  │                     │                   │  → 수식어 분해)   │           │
  │                     │                   │                  │           │
  │                     │             ┌─────┼─────┐            │           │
  │                     │          매칭성공  부분매칭  매칭실패    │           │
  │                     │             │      │       │          │           │
  │                     │          즉시응답  분해추론  AI호출     │           │
  │                     │             │      │       │          │           │
  │                     │             │      │  신규 canonical  │           │
  │                     │             └──────┴───┬───┘          │           │
  │                     │                        │              │           │
  │                     │  결과 (다국어 설명)       │              │           │
  │                     │ <──────────────────────│              │           │
  │                     │                                                  │
  │  번역된 메뉴 표시     │                                                  │
  │ <───────────────────│                                                  │
  │                     │                                                  │
  │                     │  [비동기] scan_log 기록                            │
  │                     │ ──────────────────────────────────────────────> │
  │                     │                                                  │
  │                     │        - scan_logs INSERT                        │
  │                     │        - menu_variants.scan_count++              │
  │                     │        - 미매칭 텍스트 → unmatched_texts 기록     │
  │                     │                                                  │
  │                     │                                                  │
  │  [옵션] "이 식당을    │                                                  │
  │   추천해주세요" 탭    │                                                  │
  │ ──────────────────>│                                                  │
  │                     │  카카오톡/링크 공유 (식당 등록 안내)                  │
  │                     │                                                  │
```

### DB 변화

| 테이블 | 동작 |
|---|---|
| `scan_logs` | INSERT (언어, 위치, 매칭 결과, AI 호출 여부) |
| `menu_variants` | scan_count 증가 |
| `canonical_menus` | AI 호출 시 신규 INSERT |
| `modifiers` | 새 수식어 발견 시 INSERT |
| `shops` | 위치 기반으로 미등록 식당 추정 시 draft INSERT |

### 핵심 지표

- 응답 시간 (목표: DB 매칭 < 1초, AI 호출 포함 < 5초)
- DB 히트율 (AI 호출 없이 처리된 비율)
- 미매칭 비율 (DB 성장 필요 영역 탐지)
- 지역별/언어별 스캔 분포

### 응답 시간 목표

| 처리 경로 | 목표 시간 |
|---|---|
| DB 정확 매칭 | < 0.5초 |
| 수식어 분해 매칭 | < 1초 |
| AI Discovery (신규 메뉴) | < 5초 |
| 전체 OCR + 매칭 | < 3초 (DB 히트 시) |

---

## Scenario 3: 신규 메뉴 등장 → DB 자동 확장

### 전제
- B2B 또는 B2C 흐름에서 DB에 없는 메뉴가 발견됨
- 수식어 분해로도 매칭 실패

### 시퀀스 (AI Identity Discovery)

```
Engine                      AI (GPT-4o)                    웹 서치              DB
  │                             │                              │                │
  │  미매칭 메뉴: "시래기국"      │                              │                │
  │                             │                              │                │
  │  [Step 1] DB 검색            │                              │                │
  │  - canonical_menus: 없음     │                              │                │
  │  - 수식어 분해: 실패          │                              │                │
  │  - trgm 유사: "시래기" 부분매칭 → 후보 없음                    │                │
  │                             │                              │                │
  │  [Step 2] AI Identity Discovery 호출                        │                │
  │ ──────────────────────────>│                              │                │
  │                             │                              │                │
  │  프롬프트:                    │                              │                │
  │  "다음 한국 메뉴의 정체를      │                              │                │
  │   조사해주세요: 시래기국       │                              │                │
  │   1. 무엇인가               │                              │                │
  │   2. 주재료                 │                              │                │
  │   3. 어떤 카테고리인가        │                              │                │
  │   4. 외국인에게 어떻게        │                              │                │
  │      설명할 것인가           │                              │                │
  │   5. 유사한 메뉴는           │                              │                │
  │   출력: JSON 형식으로"        │                              │                │
  │                             │                              │                │
  │                             │  [내부 지식 + 추론]             │                │
  │                             │                              │                │
  │  AI 응답:                    │                              │                │
  │  {                          │                              │                │
  │    "name_ko": "시래기국",     │                              │                │
  │    "name_en": "Dried Radish  │                              │                │
  │     Leaf Soup",              │                              │                │
  │    "concept": "국",          │                              │                │
  │    "main_ingredients":       │                              │                │
  │     ["시래기", "된장"],        │                              │                │
  │    "explanation": "...",     │                              │                │
  │    "confidence": 0.85        │                              │                │
  │  }                          │                              │                │
  │ <──────────────────────────│                              │                │
  │                             │                              │                │
  │  [Step 3] 확신도 검증         │                              │                │
  │  0.85 > 임계값(0.7) → 자동 등록                              │                │
  │  (0.7 미만이면 → 수동 검토 큐)                                │                │
  │                             │                              │                │
  │  [Step 4] DB 저장                                           │                │
  │ ──────────────────────────────────────────────────────────>│
  │                                                             │                │
  │  INSERT canonical_menus (시래기국)                            │                │
  │  INSERT evidences (AI 출처, 프롬프트 해시)                    │                │
  │  INSERT menu_relations (국 카테고리 소속)                     │                │
  │                                                             │                │
  │  [Step 5] 관계 자동 탐색                                     │                │
  │  - "시래기" 포함 다른 메뉴 검색 → "시래기된장국" 유사          │                │
  │  - concept "국"에 속한 다른 메뉴와 similar_to 후보            │                │
  │                                                             │                │
  │  [Step 6] 수식어 후보 추출                                    │                │
  │  - "시래기" → ingredient 수식어로 등록 후보                    │                │
  │  - 일정 횟수 이상 등장 시 자동 등록                            │                │
```

### DB 변화

| 테이블 | 동작 |
|---|---|
| `canonical_menus` | 신규 INSERT (status: 'active' 또는 'draft') |
| `evidences` | AI 탐색 근거 INSERT |
| `menu_relations` | 유사/소속 관계 INSERT |
| `modifiers` | 수식어 후보 등록 (반복 등장 시 확정) |
| `menu_variants` | 원래 요청의 변형 메뉴 INSERT |

### 확신도(Confidence) 정책

| 확신도 범위 | 동작 | 근거 |
|---|---|---|
| 0.9 ~ 1.0 | 자동 등록 + active | 공공 DB에도 존재, AI 확실 |
| 0.7 ~ 0.9 | 자동 등록 + active | AI 높은 확신, 사용자에게 노출 가능 |
| 0.5 ~ 0.7 | 자동 등록 + **draft** | 수동 검토 필요, 사용자에게는 "참고용" 표시 |
| 0.5 미만 | **등록 보류** | 수동 검토 큐에 추가, AI 재호출 or 사람 확인 |

### 수동 검토 큐

```
[검토 대기 목록]
┌─────────────────────────────────────────────┐
│ #1  "고씨네묵은지감자탕"  confidence: 0.45    │
│     AI 추측: 감자탕 계열 + 묵은지 + 브랜드     │
│     [확인] [수정] [분리(2개 메뉴)] [삭제]      │
│                                              │
│ #2  "엄마손칼국수"  confidence: 0.62          │
│     AI 추측: 칼국수 + 감성 수식어             │
│     [확인] [수정] [삭제]                      │
└─────────────────────────────────────────────┘
```

---

## 흐름 간 데이터 루프 (전체 그림)

```
     ┌──── B2B (사장님 업로드) ────┐
     │                            │
     │   메뉴 사진 → OCR → 매칭     │
     │        │                   │
     ▼        ▼                   │
  ┌────────────────┐              │
  │ canonical      │              │
  │ _menus (DB)    │◄─────────────┘
  │                │
  │ modifiers (DB) │◄─────────────┐
  │                │              │
  │ relations (DB) │              │
  └───────┬────────┘              │
          │                       │
          │ 조회                   │ 신규 발견
          │                       │
     ┌────▼───────────────────────┤
     │                            │
     │   B2C (외국인 촬영)          │
     │   메뉴판 촬영 → OCR → 매칭   │
     │        │                   │
     │     매칭 실패 → AI → DB 추가 ┘
     │        │
     │     매칭 성공 → 즉시 응답
     │        │
     │     scan_log 기록
     │        │
     ▼        ▼
  ┌────────────────┐
  │  scan_logs     │ → 행동 데이터 분석
  │  (스캔 로그)    │ → 지역/언어/트렌드 리포트
  └────────────────┘
```
